name: Weekly IOC Pipeline

on:
  schedule:
    - cron: "0 3 * * 0"   # Sunday 03:00 UTC
  workflow_dispatch:

jobs:
  weekly-ioc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests geoip2 reportlab python-dateutil

      # üîê Secure GeoIP download
      - name: Download GeoLite2 Country DB
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          set -e
          echo "Downloading GeoLite2 Country DB..."
          curl -sSL \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz" \
            | tar -xz --strip-components=1 --wildcards '*GeoLite2-Country.mmdb'

          if [ ! -f GeoLite2-Country.mmdb ]; then
            echo "‚ùå GeoIP DB download failed"
            exit 1
          fi

          echo "‚úÖ GeoIP DB downloaded"

      - name: Run IOC generator
        run: python generate_ioc.py

      - name: Validate output files
        run: |
          set -e
          for f in index.md weekly-ioc.csv weekly-ioc.json weekly-report.pdf; do
            [ -f "$f" ] || (echo "‚ùå Missing $f" && exit 1)
            echo "‚úÖ Found $f"
          done

      - name: Commit and push changes
        run: |
          set -e
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add .

          if git diff --cached --quiet; then
            echo "‚ùå No changes detected ‚Äì failing"
            exit 1
          fi

          git commit -m "Weekly IOC report (Malaysia, GeoIP verified)"
          git push
